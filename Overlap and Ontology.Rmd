---
title: "Overlap and Ontology"
output:
  html_document:
    df_print: paged
---

This notebook analyzes the filtered data for overlaps between conditions, and for Gene ontology or other functional annotations

```{r}
library(tidyverse)
library(here)
library(UpSetR)
```

Read in CHIKV hits file. Generated from Initial Protein Filtering RMD

```{r}
virclasp <- readRDS(here("CHIKV_Hits.rds"))
```

##Generate UpSet diagram

```{r fig.width = 12, fig.height = 6}
upset_frame <- virclasp %>%
  unite(col = condition, c(Timepoint, IFN), sep = "_") %>%
  select(condition, Accession) %>%
  mutate(exists = 1) %>%
  group_by(Accession) %>%
  spread(condition, exists, fill = 0)

inputData <- as.data.frame(upset_frame)
inputData$Accession <- as.factor(inputData$Accession)

#Define queries for plus IFN and minus IFN. Note that some intersections = 0, so will not be included in query list.

queries <- list(list(query = intersects, params = list("hour3_plus", "hour1_plus", "hour0_plus"), active = T, color = "#d8b365"),
                     list(query = intersects, params = list("hour3_plus", "hour1_plus"), active = T, color = "#d8b365"),
                     list(query = intersects, params = list("hour1_plus", "hour0_plus"), active = T, color = "#d8b365"),
                     list(query = intersects, params = list("hour3_plus"), active = T, color = "#d8b365", query.name = "+ IFN intersections"),
                     list(query = intersects, params = list("hour1_plus"), active = T, color = "#d8b365"),
                     list(query = intersects, params = list("hour3_minus", "hour1_minus"), active = T, color = "#5ab4ac"),
                     list(query = intersects, params = list("hour3_minus"), active = T, color = "#5ab4ac"),
                     list(query = intersects, params = list("hour0_minus"), active = T, color = "#5ab4ac", query.name = "- IFN intersections"))


upset(inputData, nsets = 6, 
      order.by = c("freq"), 
      sets = c("hour0_minus", "hour1_minus", "hour3_minus", "hour0_plus", "hour1_plus", "hour3_plus"),
      query.legend = "top",
      queries = queries,
      keep.order = TRUE,
      text.scale = 2,
      sets.bar.color = "#999999",
      mainbar.y.label = "Intersection Size",
      sets.x.label = "Proteins Per Condition",
      line.size = 0.8,
      point.size = 3,
      mb.ratio = c(0.65, 0.35))

```

##Plus and Minus IFN only (For discussion in text):
```{r}
plus_IFN <- virclasp %>%
  filter(IFN == "plus")

minus_IFN <- virclasp %>%
  filter(IFN == "minus")

plus_only <- plus_IFN %>%
  filter(!(Accession %in% minus_IFN$Accession))

n_distinct(plus_only$Accession)

minus_only <- minus_IFN %>%
  filter(!(Accession %in% plus_IFN$Accession))

n_distinct(minus_only$Accession)
```



##Gene Ontology

-Output the IDed proteins as a CSV of the Accession numbers. This file will be input into the tools on pantherdb.org

```{r}
write_csv(data_frame(Accession = virclasp$Accession), here("all_chikv_hits.csv"))
```

-Settings for pantherdb.org (Febrauary 28th, 2019):
  1. Enter hits file
  2. Select "homo sapiens"
  3. Select "Statistical overrepresentation test" and default settings
  4. Submit
  5. Select GO molecular function or GO biological process
  6. Fisher's exact test
  7. Use bonferroni correction
  8. Run analysis
  9. Export files. Located in "Annotations" folder (CHIKV_GO_molecularfxn.txt, CHIKV_GO_biologicalprocess.txt)

Graph
- *Remove "Unclassified" annotation prior to ggplot
- Add separate "viral" section to the graph
```{r}
molec <- read_tsv(here("Annotations", "CHIKV_GO_molecularfxn.txt"), skip = 12)
biol <- read_tsv(here("Annotations", "CHIKV_GO_biologicalprocess.txt"), skip = 12)

colnames(molec)[1] <- "GO type"
colnames(biol)[1] <- "GO type"

molec_top <- molec %>%
  filter(`GO type` != "Unclassified (UNCLASSIFIED)") %>%
  top_n(n = -10, wt = `all_chikv_hits.csv (P-value)`) %>%
  mutate(`GO analysis` = "molecular function")

biol_top <- biol %>%
  filter(`GO type` != "Unclassified (UNCLASSIFIED)") %>%
  top_n(n = -10, wt = `all_chikv_hits.csv (P-value)`) %>%
  mutate(`GO analysis` = "biological process")

biol_virus <- biol %>%
  filter(`GO type` ==  "antigen processing and presentation (GO:0019882)" | grepl("viral", `GO type`)) %>%
  mutate(`GO analysis` = "biological process") %>%
  mutate(facets = "ZOther enriched terms")



combined_go <- rbind(molec_top, biol_top) %>%
  mutate(facets = "Top 10 terms by statistical significance") %>%
  rbind(biol_virus) %>%
  mutate(`GO type` = gsub("\\s*\\([^\\)]+\\)", "", `GO type`)) %>%
  arrange(`GO analysis`, desc(`all_chikv_hits.csv (P-value)`)) %>%
  mutate(`GO type` = paste(`GO type`, "(p < ", `all_chikv_hits.csv (P-value)`, ")")) %>%
  mutate(`GO type` = forcats::fct_inorder(factor(`GO type`)))

cbPalette <- c("#e5c494", "#999999")


ggplot(combined_go, aes(x = `GO type`, y = `all_chikv_hits.csv (306)`, fill = `GO analysis`)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_manual(values=cbPalette) +
  geom_text(aes(label = `GO type`, y = 0, hjust = 0), size = 2.5) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        strip.text.y = element_text(size = 12)) +
  labs(y = "Number of Proteins", title = "GO analysis of CHIKV VIR-CLASP") +
  facet_wrap(~facets, ncol = 1)

ggsave(here("Figures/CHIKV_GO_030519.pdf"))
```







##Overlaps with previous RBP annotations

### Gerstberger Compilation
  - See rtf in "Annotations" folder for explanation of Gerstberger dataset
```{r}
gerstberger <- read_csv(here("Annotations","Gerstberger_Uniprot.csv")) %>%
  filter(Status == "reviewed") %>%
  select("Accession" = Entry)

```

### GO RNA-binding annotations
  - Retrieved from geneontology.org on 05/03/18

```{r}
go_rbp <- read_tsv(here("Annotations","RNA_binding_GO_050318.txt"), col_names = c("Accession", "Name"))
go_rbp$Accession <- gsub(pattern = "UniProtKB\\:", go_rbp$Accession, replacement = "")
go_rbp$Name = NULL
```

### Castello Interactome
  - Same protocol as Gerstberger, Ensembl ID's were converted to current version, then converted to Uniprot ID`s for comparison
```{r}
castello <- read_csv(here("Annotations", "HeLaInteractome_uniprot.csv"), col_names = "Accession")
```

##3 Baltz Interactome

```{r}
baltz <- read_csv(here("Annotations", "Baltz_uniprot.csv")) %>%
  select(Accession = Entry)
```


##Comparisons between Vir-CLASP, GO Annotated RBP's, Gerstberger RBP's, Castello RBP's, and Baltz RBP's

```{r}
virclasp_annotated <- virclasp %>%
  filter(Accession %in% go_rbp$Accession |
         Accession %in% gerstberger$Accession |
         Accession %in% castello$Accession |
         Accession %in% baltz$Accession)
print(paste("Number of annotated RBPs: ", n_distinct(virclasp_annotated$Accession)))

virclasp_unannotated <- filter(virclasp, !(Accession %in% go_rbp$Accession) &
                                         !(Accession %in% gerstberger$Accession) &
                                         !(Accession %in% castello$Accession &
                                         !(Accession %in% baltz$Accession)))
print(paste("Number of unannotated RBPs: ", n_distinct(virclasp_unannotated$Accession)))

```

##Supplementary Table generation for RBP analysis

```{r}
rbp_sources <- bind_rows("GO: RNA-binding" = go_rbp, 
                         "Gerstberger 2014" = gerstberger, 
                         "Castello 2012" = castello, 
                         "Baltz 2012" = baltz, .id = "Source")


sup_table_rbp <- rbp_sources %>%
  filter(Accession %in% virclasp$Accession) %>%
  full_join(virclasp_annotated, by = "Accession") %>%
  mutate(Name = str_extract(Description, "GN=[a-zA-Z0-9]* ")) %>%
  mutate(Name = str_trim(gsub("GN=", "", Name))) %>%
  select(Accession, Name, Description, Source) %>%
  unique() %>%
  mutate(exists = "X") %>%
  spread(Source, exists, fill = "")

write_tsv(sup_table_rbp, here("Final Tables", "Sup_Table_3.tsv"))
```


##Interferon-stimulated Genes from Interferome
-use all_chikv_hits.csv as input to interferome
-Change gene accessions to ensemble using the uniprot tool
-Use these settings for IFN search:
  -All interferon types
  -Species: homo sapiens
  -All other settings leave as default
-Some Uniprot IDs have multiple Ensemble IDs. Therefore, some Uniprot IDs will be in both annotated and unannotated, because one of its matched on Ensemble will be annotated, but another will not. To address this, we will assume that any annotation for a given Uniprot ID counts as annotated. Therefore any overlapping Uniprot IDs from chikv_isgs and chikv_non_isgs will be removed from chikv_non_isgs and left in chikv_isgs.
-Lastly, 3 uniprot IDs were not successfully mapped. These 3 protein counts will be assumed to be "unannotated". The three IDs were:
  Q6ZSR9, W6A2J7, H1ZYM0
  These correspond to uncharacterized protein FLJ45252, and two CHIKV proteins
```{r message = FALSE}
#read in accession mapping file:
ID_mapping <- read_tsv(here("Annotations", "/chikv_uniprot_ensembl_030819.txt"))

#read in annotated ISGs
ifn_genes <- read_tsv(here("Annotations", "/CHIKV_ISG_alltypes.txt"), skip = 19)

chikv_isgs <- ID_mapping %>%
  filter(To %in% ifn_genes$`Ensembl Id`)

chikv_non_isgs <- ID_mapping %>%
  filter(!(To %in% ifn_genes$`Ensembl Id`)) %>%
  filter(!(From %in% chikv_isgs$From))

print(paste("Number of annotated ISGs: ", n_distinct(chikv_isgs$From)))

print(paste("Number of unannotated ISGs: ", n_distinct(chikv_non_isgs$From) + 3))
```

##Supplementary Table generation for ISG analysis

```{r}
sup_table_isg <- virclasp %>%
  ungroup() %>%
  filter(Accession %in% chikv_isgs$From) %>%
  mutate(Name = str_extract(Description, "GN=[a-zA-Z0-9]* ")) %>%
  mutate(Name = str_trim(gsub("GN=", "", Name))) %>%
  mutate(Condition = paste(Timepoint, IFN, sep = "_")) %>%
  select(Accession, Name, Description, Condition) %>%
  unique() %>%
  mutate(exists = "X") %>%
  spread(Condition, exists, fill = "")

write_tsv(sup_table_isg, here("Final Tables", "Sup_Table_4.tsv"))
```


##Overlap between previous siRNA screen for CHIKV-modulating factors
- CHIKV "A human genome-wide loss-of-function screen identifies effective chikungunya antiviral drugs", Karlas et al, 2016, Nature communications
- VEEV "siRNA Screen Identifies Trafficking Host Factors that Modulate Alphavirus Infection", Radoshitzky et al, 2016, PLOS pathogens
- SINV "Genome-Wide RNAi Screen Identifies Novel Host Proteins Required for Alphavirus Entry", Ooi et al, 2013, PLOS pathogens
- CHIKV **overexpression "A diverse range of gene products are effectors of the type I interferon antiviral response", Schoggins et al, 2011, Nature

```{r}
#Read in different data sets and annotate with source info


karlas_proviral <- read_csv(here("Annotations", "Karlas_2016_proviral.csv"), col_names = "Entry") %>%
  mutate(Source = "Karlas Proviral") %>%
  select(Entry, Source)

karlas_antiviral <- read_csv(here("Annotations", "Karlas_2016_antiviral.csv"), col_names = "Entry") %>%
  mutate(Source = "Karlas Antiviral") %>%
  select(Entry, Source)

radoshitzky <- read_csv(here("Annotations", "radoshitzky_2016.csv")) %>%
  mutate(Source = "Radoshitzky Antviral") %>%
  select(Entry, Source)

Ooi_proviral <- read_csv(here("Annotations", "Ooi_2013_proviral.csv")) %>%
  mutate(Source = "Ooi Proviral") %>%
  select(Entry, Source)

Ooi_antiviral <- read_csv(here("Annotations", "Ooi_2013_antiviral.csv")) %>%
  mutate(Source = "Ooi Antiviral") %>%
  select(Entry, Source)

schoggins_overexpression <- read_csv(here("Annotations", "Schoggins_2011_overexpression.csv")) %>%
  mutate(Source = paste("Schoggins", effect, sep = " ")) %>%
  select(Entry, Source)

screen_data <- bind_rows(karlas_proviral, karlas_antiviral, radoshitzky, Ooi_proviral, Ooi_antiviral, schoggins_overexpression)


#Compare to VIR-CLASP dataset

virclasp_screened <- screen_data %>%
  filter(Entry %in% virclasp$Accession)

n_distinct(virclasp_screened$Entry)


#ID proteins that were overlappied in screens (should be 4)

test <- screen_data %>%
  mutate(exists = 1) %>%
  group_by(Entry) %>%
  summarize(real  = sum(exists)) %>%
  filter(real > 1 )

print(paste("Accessions found in multiple screens: ", list(test$Entry)))

```

##Supplementary Table generation for siRNA screen analysis

```{r}
sup_table_screens <- virclasp %>%
  ungroup() %>%
  filter(Accession %in% virclasp_screened$Entry) %>%
  full_join(virclasp_screened, by = c("Accession" = "Entry")) %>%
  mutate(Name = str_extract(Description, "GN=[a-zA-Z0-9]* ")) %>%
  mutate(Name = str_trim(gsub("GN=", "", Name))) %>%
  select(Accession, Name, Description, Source) %>%
  unique() %>%
  mutate(exists = "X") %>%
  spread(Source, exists, fill = "")

write_tsv(sup_table_screens, here("Final Tables", "Sup_Table_2.tsv"))
```


##Protein domain enrichment using DAVID: comparing annotated to unannotated

```{r}
domains_annotated <- read_tsv(here("Annotations", "DAVID_interpro_annotatedRBPs_CHIKV.txt"))  %>%
  top_n(n = -15, wt = Benjamini) %>%
  mutate(Annotation = "Previously Annotated RBPs")

domains_novel <- read_tsv(here("Annotations", "DAVID_interpro_novelRBPs_CHIKV.txt")) %>%
  top_n(n = -15, wt = Benjamini) %>%
  mutate(Annotation = "Putative RBPs")

combined_domains <- rbind(domains_annotated, domains_novel) %>%
  mutate(facets = "Top 15 terms by statistical significance") %>%
  mutate(Term = gsub("IPR[0-9]*\\:", "", Term)) %>%
  arrange(Annotation, desc(Benjamini)) %>%
  mutate(Benjamini = format.pval(Benjamini, digits = 2)) %>%
  mutate(Term = paste(Term, "(p < ", Benjamini, ")")) %>%
  mutate(Term = forcats::fct_inorder(factor(Term)))







ggplot(combined_domains, aes(x = Term, y = Count, fill = Annotation)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  scale_fill_manual(values=cbPalette) +
  geom_text(aes(label = Term, y = 0, hjust = 0), size = 2.5) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        strip.text.y = element_text(size = 12)) +
  labs(y = "Number of Proteins", title = "Enriched domains in annotated and putative RBPs") +
  facet_wrap(~facets, ncol = 1)

ggsave(here("Figures/CHIKV_Domains_042419.pdf"))



```


##Cellular component ontology comparing CHIKV and IAV datasets

```{r}
chikv_only <- read_tsv(here("Annotations", "IAV", "CHIKV_only_cellularcomponent.txt"), skip = 12)

iav_only <- read_tsv(here("Annotations", "IAV", "IAV_only_cellularcomponent.txt"), skip = 12)

chikv_iav_overlap <- read_tsv(here("Annotations", "IAV", "CHIKV_IAV_overlap_cellularcomponent.txt"), skip = 12)



colnames(chikv_only)[1] <- "GO type"
colnames(iav_only)[1] <- "GO type"
colnames(chikv_iav_overlap)[1] <- "GO type"

chikv_top <- chikv_only %>%
  filter(`GO type` != "Unclassified (UNCLASSIFIED)") %>%
  rename(
    P_Val = `Client Text Box Input (P-value)`,
    Count = `Client Text Box Input (232)`
  ) %>%
  top_n(n = -10, wt = P_Val) %>%
  mutate(Dataset = "CHIKV Only") %>%
  select(`GO type`, Count, P_Val, Dataset)

iav_top <- iav_only %>%
  filter(`GO type` != "Unclassified (UNCLASSIFIED)") %>%
  rename(
    P_Val = `iav_only_hits.csv (P-value)`,
    Count = `iav_only_hits.csv (64)`
  ) %>%
  top_n(n = -10, wt = P_Val) %>%
  mutate(Dataset = "IAV Only") %>%
  select(`GO type`, Count, P_Val, Dataset)

overlap_top <- chikv_iav_overlap %>%
  filter(`GO type` != "Unclassified (UNCLASSIFIED)") %>%
  rename(
    P_Val = `Client Text Box Input (P-value)`,
    Count = `Client Text Box Input (74)`
  ) %>%
  top_n(n = -10, wt = P_Val) %>%
  mutate(Dataset = "CHIKV IAV Overlap") %>%
  select(`GO type`, Count, P_Val, Dataset)


combined_cellcomponent <- rbind(chikv_top, iav_top, overlap_top) %>%
  mutate(facets = "Top 10 terms by statistical significance") %>%
  mutate(`GO type` = gsub("\\s*\\([^\\)]+\\)", "", `GO type`)) %>%
  arrange(Dataset, desc(P_Val)) %>%
  mutate(`GO type` = paste(`GO type`, "(p < ", P_Val, ")")) %>%
  mutate(`GO type` = forcats::fct_inorder(factor(`GO type`)))

cbPalette <- c("#e5c494", "#999999", "#7fbf7b")


ggplot(combined_cellcomponent, aes(x = `GO type`, y = Count, fill = `Dataset`)) +
  geom_col(width = 0.9, alpha = 0.8) +
  coord_flip() +
  scale_fill_manual(values=cbPalette) +
  geom_text(aes(label = `GO type`, y = 1, hjust = 0), size = 2.5, fontface = "italic", family = "Helvetica") +
  theme_minimal() +
  theme(text = element_text(family = "Helvetica"),
        axis.text.x = element_text(size = 12, color = "grey"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.y = element_blank(),
        strip.text.y = element_text(size = 12)) +
  labs(y = "Number of Proteins", title = "GO analysis of CHIKV vs. IAV Cellular Component") +
  facet_wrap(~facets, ncol = 1)








```



